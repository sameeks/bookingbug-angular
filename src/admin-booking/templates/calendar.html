<div bb-page>

  <div bb-admin-calendar class="bb-admin-calendar">

    <div class="page-header">
      <h1 ng-show="availability_conflict">Availability Conflict</h1>
      <h1 ng-show="!availability_conflict">Select a time</h1>
    </div>

    <div class="page-summary" ng-show="availability_conflict">

      <p>
        There's an availability conflict <span ng-show="person_name">with {{person_name}}</span><span ng-show="resource_name">in {{resource_name}}</span>.
           <!--at {{bb.current_item.defaults.datetime | datetime: 'LT'}} -->  This can be the result of: <!-- either the person or resouce requried already be booked/unavailable or that there's not enough to complete the service. You can r -->
      </p>

      <div class="row">
        <ul class="bb-bullet-list">
          <div class="col-sm-6 col-md-4">
            <li>The Staff/Resource being booked or blocked already</li>
          </div>
          <div class="col-sm-6 col-md-4">
            <li>Not enough available time to complete the booking before an existing one starts</li>
          </div>
          <div class="col-sm-6 col-md-4">
            <li>The selected time being outside of the {{bb.current_item.service.booking_time_step | time_period}} booking time step for {{bb.current_item.service.name}}.</li>
          </div>
        </ul>
      </div>

      <p>You can either use the calendar to choose another time or overbook.</p>

    </div>

    <div class="page-summary" ng-show="!availability_conflict">
      Select a time for the booking.
    </div>

    <!-- CALENDAR (with First available/Day/Week view)-->
    <div class="panel panel-default">
      <div class="panel-heading"><strong>Calendar</strong></div>
      <div class="panel-body">


        <div class="row">
          <div class="col-sm-8">

            <div class="form-inline">

              <div class="bb-label">
                <span class="glyphicon glyphicon-filter" aria-hidden="true"></span>
                Filter by:
              </div>

              <div class="form-group" ng-if="bb.company.$has('people')">
                <select bb-people class=" form-control" id="person" ng-model="person" ng-options="p.name for p in bookable_people | orderBy: 'name'">
                  <option value="">Any person</option>
                </select>
              </div>

              <div class="form-group" ng-if="bb.company.$has('resources')">
                <select bb-resources="{allow_single_pick: true}" class="form-control"  id="resource" ng-model="resource" ng-options="r.name for r in bookable_resources | orderBy: 'name'">
                  <option value="">Any resource</option>
                </select>
              </div>

            </div>
          </div>

          <div class="col-sm-4">
            <div class="bb-view-switcher hidden-xs">
              <div class="btn-group pull-right">
                <button class="btn btn-sm btn-default" ng-class="{active: calendar_view.next_available}" ng-click="switchView('next_available')" ng-if="bb.item_defaults.pick_first_time">
                  <i class="fa fa-calendar-check-o"></i> First available
                </button>
                <button class="btn btn-sm btn-default" ng-class="{active: calendar_view.day}" ng-click="switchView('day')">
                  <i class="fa fa-calendar-o"></i> Day
                </button>
                <button class="btn btn-sm btn-default" ng-class="{active: calendar_view.multi_day}" ng-click="switchView('multi_day')">
                  <i class="fa fa-calendar-o"></i>
                  <span class="visible-sm-inline">3 day</span>
                  <span class="visible-md-inline">5 day</span>
                  <span class="visible-lg-inline">7 day</span>
                </button>
              </div>
            </div>
          </div>

        </div>

        <div ng-if="calendar_view.next_available">

          <div class="bb-day-nav">

            <h2 class="hidden-xs bb-day-nav-heading">{{selected_date | datetime: 'Do MMMM YYYY'}}</h2>
            <h2 class="hidden-sm hidden-md hidden-lg bb-day-nav-heading">{{selected_date | datetime: 'Do MMMM'}}</h2>

          </div>

          <div class="bb-calendar">

            <div class="panel-group">
              <div class="bb-accordion-group">
                <div class="panel panel-default">

                  <ul class="time-slots" ng-if="slots.length > 0">

                    <li class="time-slot" ng-class="{'selected': slot.selected, 'disabled': slot.disabled}" ng-disabled="slot.disabled" ng-click="highlightSlot(slot, selected_day)" ng-repeat="slot in slots | in_the_future | limitTo: 10">
                      <span>{{slot.time_moment | datetime: 'LT'}} (in {{slot.time | tod_from_now }})</span>
                    </li>

                  </ul>

                  <p class="text-center" ng-if="slots.length == 0">No availability found, try a different time-range</p>

                </div>
              </div>

            </div>

          </div>

        </div>

        <div ng-if="calendar_view.day">

          <div class="bb-day-nav">

            <button type="button" class="btn btn-icon btn-lg" ng-click="subtract('days', 1)">
              <span class="glyphicon glyphicon-chevron-left"></span>
              <!-- <span class="hidden-xs">Previous</span> -->
            </button>

            <h2 class="hidden-xs bb-day-nav-heading">{{selected_date | datetime: 'Do MMMM YYYY'}}</h2>
            <h2 class="hidden-sm hidden-md hidden-lg bb-day-nav-heading">{{selected_date | datetime: 'Do MMMM'}}</h2>

            <button type="button" class="btn btn-icon btn-lg" ng-click="add('days', 1)">
              <span class="glyphicon glyphicon-chevron-right"></span>
              <!-- <span class="hidden-xs">Next</span> -->
            </button>

          </div>

          <div class="bb-calendar">

            <div ng-show="!slots || (slots && slots.length == 0)">
              <p class="text-center">No availability found</p>
            </div>

            <div ng-if="slots">

              <div accordion close-others="false">

                <div bb-accordion-range-group="{heading: 'Morning', range: [0, 720], collaspe_when_time_selected: true}" day="selected_day" slots="slots" select-slot="highlightSlot" ng-init="setFormDataStoreId($index)" class="accordion-group">
                </div>

                <div bb-accordion-range-group="{heading: 'Afternoon', range: [720, 1020], collaspe_when_time_selected: true}" day="selected_day" slots="slots" select-slot="highlightSlot" ng-init="setFormDataStoreId($index)" class="accordion-group">
                </div>

                <div bb-accordion-range-group="{heading: 'Evening', range: [1020, 1440], collaspe_when_time_selected: true}" day="selected_day" slots="slots" select-slot="highlightSlot" ng-init="setFormDataStoreId($index)" class="accordion-group">
                </div>

              </div>

            </div>

          </div>

        </div>

        <div ng-if="calendar_view.multi_day">
          <div bb-time-ranges="{selected_day: today}"></div>
        </div>

        <button type="button" class="btn btn-primary pull-right" ng-click="checkReady() && routeReady()" bb-debounce ng-disabled="!bb.current_item.time">Book</button>

      </div>

    </div>

    <!-- OVERBOOK (when availability conflict detected) -->
    <div class="panel panel-danger" ng-show="availability_conflict">
      <div class="panel-heading"><strong>Overbook</strong></div>
      <div class="panel-body">

        <p>Overbooking ignores booking time step and availability constraints to make a booking.</p>

        <ul class="bb-list bb-list-horizontal bb-bordered bb-block bb-block-sm">
          <li>
            <i class="fa fa-calendar" aria-hidden="true"></i>
            {{bb.current_item.defaults.datetime | datetime: 'L'}} 
          </li>
          <li>
            <i class="fa fa-clock-o" aria-hidden="true"></i>
            {{bb.current_item.defaults.datetime | datetime: 'LT'}}
          </li>
          <li ng-show="bb.current_item.defaults.person">
            <i class="fa fa-user" aria-hidden="true"></i>
            {{bb.current_item.defaults.person.name}}
          </li>
          <li ng-show="bb.current_item.defaults.resource">
            <i class="fa fa-home" aria-hidden="true"></i>
            {{bb.current_item.defaults.resource.name}}
          </li>
        </ul>

        <button type="button" class="btn btn-danger pull-right" ng-click="overBook()" bb-debounce>Overbook</button>

      </div>

    </div>

  </div>

  <div class="bb-step-navigation">
    <div class="row">
      <div class="col-sm-9 col-sm-push-3 text-right"></div>
      <div class="col-sm-3 col-sm-pull-9">
        <button type="button" class="btn btn-default" bb-debounce ng-click="loadPreviousStep()" ng-show="bb.current_step > 1">Back</button>
      </div>
    </div>
  </div>

</div>
